define nop(): unit {
  Unit
}

define except-bind<e, a, b>(x: except(e, a), k: (a) -> except(e, b)): except(e, b) {
  match x {
  | Error(err) =>
    Error(err)
  | OK(value) =>
    k(value)
  }
}

define test(): except(&text, int) {
  with except-bind {
    bind _: bool = Error("hello") in
    let x = type in
    let _ on x =
      let _ = x in
      type
    in
    let _ = x in
    letbox _ = box {type} in
    bind _: bool = Error("hello") in
    let _ = type in
    bind _: bool = OK(True) in
    nop();
    bind _: bool =
      bind _: bool = OK(True) in
      nop();
      let _ = type in
      Error("hello")
    in
    bind _: bool = Error("hello") in
    bind _: bool = Error("hello") in
    nop();
    bind _: type = OK(int) in
    OK(10)
  }
}

define test2(): except(int, int) {
  with except-bind {
    bind _: bool = Error(3) in
    let _ = type in
    bind _: bool = Error(5) in
    let _ = type in
    bind _: bool = OK(True) in
    nop();
    let tmp = type in
    bind _: bool =
      let k = type in
      pin _ on k =
        let _ = k in
        tmp
      in
      bind _: bool = OK(True) in
      nop();
      let _ = type in
      Error(7)
    in
    let _: type = tmp in
    bind _: bool = Error(9) in
    bind _: bool = Error(11) in
    nop();
    bind _: type = OK(int) in
    OK(10)
  }
}

define main(): unit {
  let _ = test() in
  Unit
}
