import {
- core.top
- core.list => L
- core.vector => V
}

variant list(a: tau) {
- Nil()
- Cons(a, list(a))
}

define my-length(xs: &list(i64)): i64 {
  case xs {
  - Nil() =>
    0
  - Cons(_, ys) =>
    add-i64(1, my-length(ys))
  }
}

define bar(xs-cell: &cell(list(i64))): i64 {
  borrow(xs-cell, my-length)
}

define main(): i64 {
  let xs: list(i64) = Cons(1, Cons(2, Nil()))
  let xs-cell = new-cell(xs)
  let result on xs-cell = {
    let _ = bar(xs-cell)
    mutate(xs-cell, lambda (xs) {
      Cons(4, xs)
    })
    let _ = bar(xs-cell)
    mutate(xs-cell, lambda (_) {
      Nil()
    })
    mutate(xs-cell, lambda (xs) {
      Cons(4, xs)
    })
    bar(xs-cell)
  }
  let _ = xs-cell
  result
}
