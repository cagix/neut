import {
- core.top
}

variant list(a: tau) {
- Nil()
- Cons(a, list(a))
}

define-inline get<a>(x: cell a): a {
  let value-noema: &a = magic load(pointer(i8), x)
  !value-noema
}

define-inline mutate<a>(x: cell a, mutator: a -> a): core.top::top() {
  let value: a = magic load(pointer(i8), x)
  let mutated-value = mutator(value)
  magic store(pointer(i8), x, mutated-value)
}

define length(xs: list(i64)): i64 {
  match xs {
  - list.Nil() =>
    0
  - list.Cons(y, ys) =>
    add-i64(1, length(ys))
  }
}

define bar(xs: cell list(i64)): i64 {
  length(get(xs))
}

define main(): i64 {
  let xs: list(i64) = [1, 2]
  let result on mutable xs = {
    let len1 = bar(xs)
    mutate(xs, lambda (xs) {
      list.Cons(4, xs)
    })
    let len2 = bar(xs)
    mutate(xs, lambda (xs) {
      list.Nil()
    })
    mutate(xs, lambda (xs) {
      list.Cons(4, xs)
    })
    bar(xs)
  }
  result
}
